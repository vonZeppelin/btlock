package org.lbogdanov.btlock.ui;

import static org.lbogdanov.btlock.App.BUS;
import com.squareup.otto.Subscribe;
import org.lbogdanov.btlock.events.*;
import org.slf4j.*;
import java.io.IOException;
import javafx.event.ActionEvent;
import javafx.fxml.*;
import javafx.scene.control.*;

public class ScanDialog extends Dialog<Void> {
    private static final Logger logger = LoggerFactory.getLogger(ScanDialog.class);

    public static class Controller {
        @FXML private ListView<PeripheralDiscovered> devicesList;
        @FXML private Button connectButton;

        @FXML public void connect(ActionEvent event) {
            System.out.println(event);
        }

        @Subscribe public void peripheralDiscovered(PeripheralDiscovered event) {
            devicesList.getItems().add(event);
        }

        public void initialize() {
            BUS.register(this);

            connectButton.disableProperty().bind(
                devicesList.getSelectionModel().selectedItemProperty().isNull()
            );
        }
    }

    public ScanDialog() {
        try {
            FXMLLoader loader = new FXMLLoader(
                getClass().getResource("/ScanDialog.fxml")
            );
            DialogPane dialogPane = getDialogPane();
            dialogPane.getButtonTypes().addAll(ButtonType.CLOSE);
            dialogPane.setContent(loader.load());

            setOnHidden(evt -> BUS.unregister(loader.getController()));
            setOnShown(evt -> BUS.post(new StartDiscovery()));
        } catch (IOException e) {
            logger.error("Couldn't load ScanDialog from FXML document", e);
        }
    }
}
